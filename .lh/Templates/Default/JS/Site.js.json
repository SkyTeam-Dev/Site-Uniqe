{
    "sourceFile": "Templates/Default/JS/Site.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 6,
            "patches": [
                {
                    "date": 1751985351660,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1751985492356,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,13 +1,13 @@\n /* ################## input mask ################## */\r\n \r\n $(document).ready(function(){\r\n \r\n-    $('#nascimento').mask('00/00/0000');\r\n-    $('#cep').mask('00000-000');\r\n-    $('#cep_API').mask('00000-000');\r\n-    $('#cpf').mask('000.000.000-00', {reverse: true});\r\n-    $('#cnpj').mask('00.000.000/0000-00', {reverse: true});\r\n+    $('#NASCIMENTO').mask('00/00/0000');\r\n+    $('#CEP').mask('00000-000');\r\n+    $('#CEP_API').mask('00000-000');\r\n+    $('#CPF').mask('000.000.000-00', {reverse: true});\r\n+    $('#CNPJ').mask('00.000.000/0000-00', {reverse: true});\r\n \r\n     var maskBehavior = function(val) {\r\n         return val.replace(/\\D/g, '').length === 11 ? '(00) 0 0000-0000' : '(00) 0000-00009';\r\n       },\r\n@@ -16,9 +16,9 @@\n           field.mask(maskBehavior.apply({}, arguments), options);\r\n         }\r\n       };\r\n       \r\n-      $('#celular').mask(maskBehavior, options);\r\n+      $('#TELEFONE').mask(maskBehavior, options);\r\n       $('#celular_agencia').mask(maskBehavior, options);\r\n       $('#Telefone_agencia').mask(maskBehavior, options);\r\n \r\n \r\n"
                },
                {
                    "date": 1751986160831,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,9 +2,9 @@\n \r\n $(document).ready(function(){\r\n \r\n     $('#NASCIMENTO').mask('00/00/0000');\r\n-    $('#CEP').mask('00000-000');\r\n+    $('#CEP').mask('00.000-000');\r\n     $('#CEP_API').mask('00000-000');\r\n     $('#CPF').mask('000.000.000-00', {reverse: true});\r\n     $('#CNPJ').mask('00.000.000/0000-00', {reverse: true});\r\n \r\n"
                },
                {
                    "date": 1751986189974,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,9 +2,9 @@\n \r\n $(document).ready(function(){\r\n \r\n     $('#NASCIMENTO').mask('00/00/0000');\r\n-    $('#CEP').mask('00.000-000');\r\n+    $('#CEP').mask('000.00-000');\r\n     $('#CEP_API').mask('00000-000');\r\n     $('#CPF').mask('000.000.000-00', {reverse: true});\r\n     $('#CNPJ').mask('00.000.000/0000-00', {reverse: true});\r\n \r\n"
                },
                {
                    "date": 1751990878558,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3,9 +3,9 @@\n $(document).ready(function(){\r\n \r\n     $('#NASCIMENTO').mask('00/00/0000');\r\n     $('#CEP').mask('000.00-000');\r\n-    $('#CEP_API').mask('00000-000');\r\n+    $('#CEP_API').mask('000.00-000');\r\n     $('#CPF').mask('000.000.000-00', {reverse: true});\r\n     $('#CNPJ').mask('00.000.000/0000-00', {reverse: true});\r\n \r\n     var maskBehavior = function(val) {\r\n"
                },
                {
                    "date": 1751995985871,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -16,9 +16,9 @@\n           field.mask(maskBehavior.apply({}, arguments), options);\r\n         }\r\n       };\r\n       \r\n-      $('#TELEFONE').mask(maskBehavior, options);\r\n+      $('#Telefone').mask(maskBehavior, options);\r\n       $('#celular_agencia').mask(maskBehavior, options);\r\n       $('#Telefone_agencia').mask(maskBehavior, options);\r\n \r\n \r\n"
                },
                {
                    "date": 1752001742960,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,4 +1,18 @@\n+\r\n+// script para forçar reflow nos inputs ao abrir a modal\r\n+const modal = document.getElementById('CadastroUniqe');\r\n+modal.addEventListener('shown.bs.modal', () => {\r\n+  // Força um \"repaint\" no conteúdo da modal\r\n+  modal.querySelectorAll('input').forEach(input => {\r\n+    input.style.display = 'none';\r\n+    input.offsetHeight; // força reflow\r\n+    input.style.display = '';\r\n+  });\r\n+});\r\n+\r\n+\r\n+\r\n /* ################## input mask ################## */\r\n \r\n $(document).ready(function(){\r\n \r\n"
                }
            ],
            "date": 1751985351660,
            "name": "Commit-0",
            "content": "/* ################## input mask ################## */\r\n\r\n$(document).ready(function(){\r\n\r\n    $('#nascimento').mask('00/00/0000');\r\n    $('#cep').mask('00000-000');\r\n    $('#cep_API').mask('00000-000');\r\n    $('#cpf').mask('000.000.000-00', {reverse: true});\r\n    $('#cnpj').mask('00.000.000/0000-00', {reverse: true});\r\n\r\n    var maskBehavior = function(val) {\r\n        return val.replace(/\\D/g, '').length === 11 ? '(00) 0 0000-0000' : '(00) 0000-00009';\r\n      },\r\n      options = {\r\n        onKeyPress: function(val, e, field, options) {\r\n          field.mask(maskBehavior.apply({}, arguments), options);\r\n        }\r\n      };\r\n      \r\n      $('#celular').mask(maskBehavior, options);\r\n      $('#celular_agencia').mask(maskBehavior, options);\r\n      $('#Telefone_agencia').mask(maskBehavior, options);\r\n\r\n\r\n});\r\n\r\n\r\n\r\n/* ################## BUSCA CNPJ COM VALIDAÇÃO E FALBACK ################## */\r\n\r\nvar cnpjErrorCache = {};\r\nvar debugLogs = [];\r\n\r\nfunction logDebug(message) {\r\n    debugLogs.push(message);\r\n    console.log(\"[DEBUG] \" + message);\r\n}\r\n\r\nfunction formatarCNPJ(cnpj) {\r\n    if (typeof cnpj !== 'string') {\r\n        cnpj = String(cnpj); // Converte para string\r\n    }\r\n    return cnpj.replace(/^(\\d{2})(\\d{3})(\\d{3})(\\d{4})(\\d{2})/, \"$1.$2.$3/$4-$5\");\r\n}\r\n\r\ndocument.getElementById(\"cnpj\").addEventListener(\"blur\", function () {\r\n    logDebug(\"Iniciando processo de consulta...\");\r\n\r\n    var cnpj = this.value.replace(/\\D/g, \"\");\r\n    var loadingIndicator = document.getElementById(\"cnpj-loading\");\r\n\r\n    // Exibe o indicador de carregamento\r\n    loadingIndicator.style.display = \"inline-block\";\r\n\r\n    if (cnpjErrorCache[cnpj]) {\r\n        logDebug(\"CNPJ \" + cnpj + \" já consta no cache de erros. Consulta abortada.\");\r\n        loadingIndicator.style.display = \"none\";\r\n        return;\r\n    }\r\n\r\n    if (!/^\\d{14}$/.test(cnpj)) {\r\n        logDebug(\"CNPJ inválido detectado: \" + cnpj);\r\n        alert(\"CNPJ inválido. Verifique o formato.\");\r\n        loadingIndicator.style.display = \"none\";\r\n        return;\r\n    }\r\n\r\n    // Definição das APIs com suas respectivas URLs\r\n    var apis = [\r\n        {\r\n            name: \"BrasilAPI\",\r\n            url: \"https://brasilapi.com.br/api/cnpj/v1/\" + cnpj\r\n            // Caso persista problema de CORS, considere utilizar um proxy (ex.: window.location.origin + \"/proxy.php?cnpj=\" + cnpj)\r\n        },\r\n        {\r\n            name: \"InverTexto\",\r\n            url: \"https://api.invertexto.com/v1/cnpj/\" + cnpj + \"?token=16473|OtgHBLImQHYqSJIIbFZy3FEeCWRADS4w\"\r\n        },\r\n        {\r\n            name: \"CNPJs.dev\",\r\n            url: \"https://api.cnpjs.dev/v1/\" + cnpj\r\n        }\r\n    ];\r\n\r\n    // Embaralha a ordem das APIs para tentativas aleatórias\r\n    apis.sort(() => Math.random() - 0.5);\r\n    logDebug(\"Ordem de tentativa: \" + apis.map(api => api.name).join(\" → \"));\r\n\r\n    // Função que processa a resposta de acordo com a API utilizada\r\n    function processarResposta(data, selectedAPI) {\r\n        logDebug(\"Resposta da API \" + selectedAPI.name + \" recebida com sucesso\");\r\n        delete cnpjErrorCache[cnpj];\r\n\r\n        // Oculta o indicador de carregamento assim que a resposta é processada\r\n        loadingIndicator.style.display = \"none\";\r\n\r\n        var formMapper = {};\r\n\r\n        // Mapeamento para cada API com base na documentação:\r\n        if (selectedAPI.name === \"BrasilAPI\") {\r\n            formMapper = {\r\n                razaoSocial: data.razao_social,\r\n                nomeFantasia: data.nome_fantasia || \"\",\r\n                situacao_cadastral: data.descricao_situacao_cadastral,\r\n                simples_nacional: data.opcao_pelo_simples,\r\n                mei: data.opcao_pelo_mei,\r\n                cep_API: data.cep\r\n            };\r\n            console.table(data);\r\n        } else if (selectedAPI.name === \"CNPJs.dev\") {\r\n            formMapper = {\r\n                razaoSocial: data.razao_social,\r\n                nomeFantasia: data.nome_fantasia || \"\",\r\n                situacao_cadastral: data.situacao_cadastral,\r\n                simples_nacional: false, // Não informado na API; defina conforme sua lógica\r\n                mei: false,\r\n                cep_API: data.endereco && data.endereco.cep ? data.endereco.cep : \"\"\r\n            };\r\n            console.table(data);\r\n        } else if (selectedAPI.name === \"InverTexto\") {\r\n            formMapper = {\r\n                razaoSocial: data.razao_social,\r\n                nomeFantasia: data.nome_fantasia || \"\",\r\n                situacao_cadastral: data.situacao,\r\n                simples_nacional: (data.simples && data.simples.optante_simples === \"S\") ? true : false,\r\n                mei: (data.mei && data.mei.optante_mei === \"S\") ? true : false,\r\n                cep_API: data.endereco ? data.endereco.cep : \"\"\r\n            };\r\n            console.table(data);\r\n        }\r\n\r\n        // Preenche os inputs correspondentes (certifique-se de que os elementos com os ids existem no HTML)\r\n        for (var field in formMapper) {\r\n            if (formMapper.hasOwnProperty(field)) {\r\n                var input = document.getElementById(field);\r\n                if (input) input.value = formMapper[field] || \"\";\r\n            }\r\n        }\r\n    }\r\n\r\n    // Função que tenta cada API em sequência com delay entre tentativas\r\n    function tryNextAPI(index) {\r\n        if (index >= apis.length) {\r\n            logDebug(\"Todas as APIs falharam\");\r\n            cnpjErrorCache[cnpj] = true;\r\n            alert(\"Falha em todas as tentativas. CNPJ bloqueado temporariamente.\");\r\n            loadingIndicator.style.display = \"none\";\r\n            return;\r\n        }\r\n\r\n        // Delay crescente entre as tentativas (2.5s, 5s, 7.5s, etc.)\r\n        setTimeout(() => {\r\n            var selectedAPI = apis[index];\r\n            logDebug(\"Tentando API: \" + selectedAPI.name + \" (\" + (index + 1) + \"/\" + apis.length + \")\");\r\n\r\n            fetch(selectedAPI.url, {\r\n                method: \"GET\",\r\n                headers: {\r\n                    // Cabeçalhos necessários, sem o 'X-Requested-With'\r\n                    \"User-Agent\": \"Ws4SkyTeam/1.0 (+ \" + window.location.origin + \")\",\r\n                    \"Accept\": \"application/json\",\r\n                    \"Content-Type\": \"application/json\"\r\n                }\r\n            })\r\n                .then(response => {\r\n                    logDebug(\"Status da resposta: \" + response.status);\r\n                    if (!response.ok) throw new Error(\"Erro na API\");\r\n                    return response.json();\r\n                })\r\n                .then(data => {\r\n                    processarResposta(data, selectedAPI);\r\n                })\r\n                .catch(error => {\r\n                    logDebug(\"Erro na API \" + selectedAPI.name + \": \" + error.message);\r\n                    tryNextAPI(index + 1);\r\n                });\r\n        }, index * 2500);\r\n    }\r\n\r\n    tryNextAPI(0);\r\n});"
        }
    ]
}